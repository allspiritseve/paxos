<!DOCTYPE html>

<html>
<head>
  <title>writer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="acceptor.js.html">
                  acceptor.js
                </a>


                <a class="source" href="completion.js.html">
                  completion.js
                </a>


                <a class="source" href="paxos.js.html">
                  paxos.js
                </a>


                <a class="source" href="proposer.js.html">
                  proposer.js
                </a>


                <a class="source" href="recorder.js.html">
                  recorder.js
                </a>


                <a class="source" href="replay.js.html">
                  replay.js
                </a>


                <a class="source" href="shaper.js.html">
                  shaper.js
                </a>


                <a class="source" href="writer.js.html">
                  writer.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>writer.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)

<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Writer</span> (<span class="hljs-params">paxos, promise, proposals</span>) </span>{
    <span class="hljs-keyword">this</span>._paxos = paxos
    <span class="hljs-keyword">this</span>.collapsed = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>._previous = promise</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is the right data structure for the job. It is an array of proposals
that can have at most one proposals for a new government, where that
proposal is unshifted into the array and all the subsequent proposals
have their promises remapped to the new government.</p>
<p>Returning to this, I felt that it made no sense, just push the new
governent onto the end of the array, but then you’re moving toward scan
the array for an existing government to assert that it is not there, or
else queuing governments based on either the current government, or the
last future government pushed onto the proposal array.</p>
<p>Although it’s not multi-dimensional, I see this structure in my mind as
somehow ether dash shapped, an array of just proposals, or L shaped an
array of proposals with a new government unshifted.</p>
<p>Sometimes there’s a scout leader, and sometimes there’s not.</p>
<p>But, the array is the correct structure. It makes the remapping easy.</p>
<p>Governments jumping the gun is the right way to go, and here’s how we
prioritize them, by constantly unshifting only the next one onto the
array.</p>
<p>This means that there is a queue of awaiting governments. It is, however,
implicit. We will review our current government when we create a new one,
and when a ping changes the reachable state of a constituent. Recall that
a new government is formed to immigrate or exile a citizen.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.proposals = proposals
    <span class="hljs-keyword">this</span>._writing = <span class="hljs-literal">false</span>
}

Writer.prototype.push = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">proposal</span>) </span>{
    <span class="hljs-keyword">this</span>.proposals.push({
        <span class="hljs-attr">quorum</span>: proposal.quorum,
        <span class="hljs-attr">promise</span>: proposal.promise,
        <span class="hljs-attr">body</span>: proposal.body
    })
}

Writer.prototype.unshift = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">proposal</span>) </span>{
    <span class="hljs-keyword">this</span>.proposals.unshift({
        <span class="hljs-attr">quorum</span>: proposal.quorum,
        <span class="hljs-attr">promise</span>: proposal.promise,
        <span class="hljs-attr">body</span>: proposal.body
    })
}

Writer.prototype._send = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> proposal = <span class="hljs-keyword">this</span>.proposals.shift()
    <span class="hljs-keyword">this</span>._writing = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">this</span>._paxos._send({
        <span class="hljs-attr">method</span>: <span class="hljs-string">'register'</span>,
        <span class="hljs-attr">to</span>: proposal.quorum,
        <span class="hljs-attr">collapsible</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">constituent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">register</span>: {
            <span class="hljs-attr">body</span>: {
                <span class="hljs-attr">promise</span>: proposal.promise,
                <span class="hljs-attr">body</span>: proposal.body,
                <span class="hljs-attr">previous</span>: <span class="hljs-keyword">this</span>._previous
            },
            <span class="hljs-attr">previous</span>: <span class="hljs-literal">null</span>
        }
    })
}

Writer.prototype.nudge = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._writing &amp;&amp; <span class="hljs-keyword">this</span>.proposals.length != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>._send()
    }
}

Writer.prototype.collapse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">now</span>) </span>{
    <span class="hljs-keyword">this</span>._paxos._collapse(now)
}

Writer.prototype.response = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">now, request, responses</span>) </span>{
    assert(request.method == <span class="hljs-string">'register'</span>, <span class="hljs-string">'unexpected request type'</span>)
    <span class="hljs-keyword">this</span>._previous = request.register.body.promise
    <span class="hljs-keyword">this</span>._paxos._register(now, request.register)
    <span class="hljs-keyword">this</span>._writing = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.proposals.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>._paxos.scheduler.schedule(now, <span class="hljs-keyword">this</span>._paxos.id, {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'synchronize'</span>,
            <span class="hljs-attr">to</span>: <span class="hljs-keyword">this</span>._paxos.government.majority,
            <span class="hljs-attr">collapsible</span>: <span class="hljs-literal">true</span>
        })
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._send()
    }
}

Writer.prototype.createWriter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promise</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Writer(<span class="hljs-keyword">this</span>._paxos, promise, <span class="hljs-keyword">this</span>.proposals)
}

Writer.prototype.inspect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'Writer'</span>, <span class="hljs-attr">proposals</span>: <span class="hljs-keyword">this</span>.proposals }
}

<span class="hljs-built_in">module</span>.exports = Writer</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
