<!DOCTYPE html>

<html>
<head>
  <title>relay.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="acceptor.js.html">
                  acceptor.js
                </a>


                <a class="source" href="assembly.js.html">
                  assembly.js
                </a>


                <a class="source" href="completion.js.html">
                  completion.js
                </a>


                <a class="source" href="legislator.js.html">
                  legislator.js
                </a>


                <a class="source" href="log.js.html">
                  log.js
                </a>


                <a class="source" href="paxos.js.html">
                  paxos.js
                </a>


                <a class="source" href="pinger.js.html">
                  pinger.js
                </a>


                <a class="source" href="proposer.js.html">
                  proposer.js
                </a>


                <a class="source" href="recorder.js.html">
                  recorder.js
                </a>


                <a class="source" href="redux.js.html">
                  redux.js
                </a>


                <a class="source" href="relay.js.html">
                  relay.js
                </a>


                <a class="source" href="replay.js.html">
                  replay.js
                </a>


                <a class="source" href="shape.js.html">
                  shape.js
                </a>


                <a class="source" href="shaper.js.html">
                  shaper.js
                </a>


                <a class="source" href="writer.js.html">
                  writer.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>relay.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>We identify our representative by immigration promise instead of name on the
off chance we’ve been isolated for so long that our representative not only
restarted but also managed to rejoin parliament and resume it’s position as
our representative.</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>See <code>createRelay</code> below for more thoughts.</p>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO Come up with a name for this, name and immigration?</p>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Relay</span> (<span class="hljs-params">representative</span>) </span>{
    <span class="hljs-keyword">this</span>._representative = representative
    <span class="hljs-keyword">this</span>.outbox = {}
    <span class="hljs-keyword">this</span>._sent = {}
}

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Our outbox is sent on the ride back from a request. We are the constituent,
they are the representative. Information flows from representative to
constituent, for the most part, while this is the feedback that will
eventually make it to the leader.</p>
<p>When our representative gets the contents of our outbox in the response, it
will make note of it send a receipt on the next pulse. If for some reason
this receipt is lost we’ll end up sending the same outbox again &mdash; maybe
with more or updated entries.</p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The duplication is not a problem. Denizens only ever move from reachable to
unreachable, the value of the top of their log only ever increases.</p>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A receipt takes the same form as our outbox.</p>

            </div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Relay.prototype.received = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">receipt</span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> receipt) {
</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>We only remove an item if we know that our representative has the
same value that we have.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (
            <span class="hljs-keyword">this</span>.outbox[name] != <span class="hljs-literal">null</span> &amp;&amp;
            <span class="hljs-keyword">this</span>.outbox[name].reachable == receipt[name].reachable &amp;&amp;
            <span class="hljs-keyword">this</span>.outbox[name].committed == receipt[name].committed
        ) {
            <span class="hljs-keyword">this</span>._sent[name] = <span class="hljs-keyword">this</span>.outbox[name]
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.outbox[name]
        }
    }
}

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TODO Come back and write about this. We are updated by our pinger and by our
constituents, that is we may be actively determining reachablity of some
denizens, accepting feedback about others.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Relay.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, reachable, committed</span>) </span>{
    <span class="hljs-keyword">if</span> (
</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>We always update our outbox if we nothing going on at all.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        (
            <span class="hljs-keyword">this</span>._sent[name] == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.outbox[name] == <span class="hljs-literal">null</span>
        ) ||
</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Otherwise if the denizen is currently reachable reachable, then we
update our state if the denizen is now unreachable or if its
maximum committed promise has changed.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        (
            (<span class="hljs-keyword">this</span>.outbox[name] || <span class="hljs-keyword">this</span>._sent[name]).reachable
            &amp;&amp;
            (!reachable || <span class="hljs-keyword">this</span>._sent[name].committed != committed)
        )
    ) {
        <span class="hljs-keyword">this</span>.outbox[name] = { <span class="hljs-attr">reachable</span>: reachable, <span class="hljs-attr">committed</span>: committed }
    }
}

</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>As noted above in the constructor, we use the representative’s immigration
promise instead of it’s name to uniquely identify it. If we have a new
representative we will replace ourselves with a new <code>Relay</code> to reset our sent
state.</p>

            </div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Relay.prototype.createRelay = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">representative</span>) </span>{
    <span class="hljs-keyword">if</span> (representative == <span class="hljs-keyword">this</span>._representative) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Relay(representative)
}

<span class="hljs-built_in">module</span>.exports = Relay

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
