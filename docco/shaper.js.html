<!DOCTYPE html>

<html>
<head>
  <title>shaper.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="acceptor.js.html">
                  acceptor.js
                </a>


                <a class="source" href="completion.js.html">
                  completion.js
                </a>


                <a class="source" href="paxos.js.html">
                  paxos.js
                </a>


                <a class="source" href="proposer.js.html">
                  proposer.js
                </a>


                <a class="source" href="recorder.js.html">
                  recorder.js
                </a>


                <a class="source" href="replay.js.html">
                  replay.js
                </a>


                <a class="source" href="shaper.js.html">
                  shaper.js
                </a>


                <a class="source" href="writer.js.html">
                  writer.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>shaper.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Monitor the reachability of islanders in order to suggest the shape of a new
government. The <code>Shaper.update</code> method is invoked with a islander id and a
reachability status. <code>Shaper.update</code> returns either a new government to
appoint or <code>null</code>. Once <code>Shaper.update</code> returns a new government to appoint
the <code>Shaper</code> object is used up and should be replaced.</p>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We determine reachability elsewhere so that the <code>Shaper.update</code> method is
only ever called with a true or false value for reachable. For the purposes
of <code>Shaper</code> reachability is defined as follows.</p>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <ul>
<li>A islander is reachable if the islander responds to pings and has
acclimated.</li>
<li>A islander is unreachable if the islander does not respond to pings.</li>
</ul>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If the islander responds to pings, but has not acclimated, it is neither
reachable nor unreachable and we don’t want to hear about it.</p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Notes:</p>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Could think harder about priorities as they relate to healing. Wouldn’t want
to starve the recovery of the cluster by performing arrivals only, when newly
acclimated islanders could join the legislature and preserve the republic.</p>

            </div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Note that we currently favor impeachment because the minority updates the
constituents. A non-functioning minority member would keep all of its
constituents in the dark.</p>

            </div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>We favor filling empty seats in government as soon as they are detected.</p>

            </div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>We favor shrinking the government as soon as it becomes obvious that the
government size is less than the population of the island.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>All this assuming an external mechanism for tracking pings that will
calculate when a particular islander is reachable or unreachable. After
<code>update</code> returns a reshape operation, the <code>Shaper</code> object is consumed. At
that point you should no longer call <code>Shaper</code>. Put a dummy shape object in
its place.</p>

            </div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>A new <code>Shaper</code> object should then be created when a new government is
created.</p>

            </div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>I’m imagining that the unreachability of an islander will be remembered so
that when a new government is created the unreachability can replayed. Causes
me to muse about whether it should be possible for a islander to become
reachable again, whether we should continue to ping the islander, or if we
simply surrender.</p>

            </div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>In the case of collapse when we switch to paxos, it seems that we’ll keep on
trying and trying such that we could recover from a network outage in the
case of paxos.</p>

            </div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO Try to recall what you need to do to grow correctly. Who is supposed to
be in that quorum?</p>

            </div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO Work into the words above that filling seats is urgent, but not
expanding the government to the desired government size.</p>

            </div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO Stop saying “quorum” when you mean “seats filled.”</p>

            </div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Shaper</span> (<span class="hljs-params">parliamentSize, government, recovered</span>) </span>{
    <span class="hljs-keyword">this</span>._parliamentSize = government.majority.length * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">this</span>._shouldExpand = parliamentSize != <span class="hljs-keyword">this</span>._parliamentSize
    <span class="hljs-keyword">this</span>._government = government
    <span class="hljs-keyword">this</span>._seen = {}
    <span class="hljs-keyword">this</span>._expandable = []
    <span class="hljs-keyword">this</span>._arriving = []
    <span class="hljs-keyword">this</span>.decided = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>._governments = []
    <span class="hljs-keyword">this</span>.outbox = {}
    <span class="hljs-keyword">this</span>._representative = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">this</span>._shouldNaturalize = <span class="hljs-keyword">this</span>._government.majority.length +
        <span class="hljs-keyword">this</span>._government.minority.length +
        <span class="hljs-keyword">this</span>._government.constituents.length != <span class="hljs-keyword">this</span>._government.acclimated.length
    <span class="hljs-keyword">this</span>._shouldRecover(recovered) || <span class="hljs-keyword">this</span>._shouldContract()
}

Shaper.prototype._shouldRecover = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">recovered</span>) </span>{
    <span class="hljs-keyword">if</span> (recovered) {
        <span class="hljs-keyword">this</span>._governments.push({
            <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">government</span>: {
                <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
                <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority
            }
        })
    }
}

Shaper.prototype._shouldContract = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">this</span>._government.promise != <span class="hljs-string">'0/0'</span> &amp;&amp;
        <span class="hljs-keyword">this</span>._government.majority.length + <span class="hljs-keyword">this</span>._government.minority.length != <span class="hljs-keyword">this</span>._parliamentSize
    ) {
        <span class="hljs-keyword">var</span> majority = <span class="hljs-keyword">this</span>._government.majority.slice()
        <span class="hljs-keyword">var</span> minority = <span class="hljs-keyword">this</span>._government.minority.slice()
        minority.unshift(majority.pop())
        <span class="hljs-keyword">var</span> demote = minority.pop()
        <span class="hljs-keyword">this</span>._governments.push({
            <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">government</span>: {
                <span class="hljs-attr">majority</span>: majority,
                <span class="hljs-attr">minority</span>: minority,
                <span class="hljs-attr">demote</span>: demote
            }
        })
    }
}

Shaper.prototype.unreachable = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">unreachable</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.decided) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">this</span>._government.arrived.id[unreachable]
    assert(id != <span class="hljs-literal">null</span>, <span class="hljs-string">'unable to determine unreachable id'</span>)</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Depart any unreachable islanders.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._governments.shift() || {
        <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
        <span class="hljs-attr">government</span>: {
            <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$id</span>) </span>{ <span class="hljs-keyword">return</span> $id != id }),
            <span class="hljs-attr">departed</span>: id
        }
    }
}

Shaper.prototype.acclimate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promise</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.decided) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">var</span> government = <span class="hljs-keyword">this</span>._government

    <span class="hljs-keyword">var</span> id = government.arrived.id[promise]
    assert(id != <span class="hljs-literal">null</span>, <span class="hljs-string">'unable to determine acclimate id'</span>)


    assert(!~government.acclimated.indexOf(id), <span class="hljs-string">'already acclimated'</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._governments.shift() || {
        <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
        <span class="hljs-attr">government</span>: {
            <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority,
            <span class="hljs-attr">acclimate</span>: id
        }
    }
}</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>Shaper.update</code> determines if a new government should be created that has a
new shape. Note that embark and arrive takes place is elsewhere.</p>

            </div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Shaper.prototype.acclimated = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.decided) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>We’re not going to return an expanded government until we get two
expandable entries so if we have a contraction it will go the first time
acclimated is called.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (~<span class="hljs-keyword">this</span>._government.majority.indexOf(id)) {</pre></div></div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Majority members are not our responsibility. They trigger their own
collapse.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._shouldExpand &amp;&amp; !~<span class="hljs-keyword">this</span>._government.minority.indexOf(id)) {
        <span class="hljs-keyword">this</span>._expandable.push(id)</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>TODO Is the quorum the new majority or the old majority?
TODO Think about growth commit race conditions again.</p>

            </div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._expandable.length == <span class="hljs-number">2</span>) {</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>We should expand and we have islanders who can be appointed to
the government so let’s grow the government.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> majority = <span class="hljs-keyword">this</span>._government.majority.slice()
            <span class="hljs-keyword">var</span> minority = <span class="hljs-keyword">this</span>._government.minority.slice()
            <span class="hljs-keyword">var</span> promote = [ <span class="hljs-keyword">this</span>._expandable.shift(), <span class="hljs-keyword">this</span>._expandable.shift() ]
            minority.push.apply(minority, promote)
            majority.push(minority.shift())
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">quorum</span>: majority,
                <span class="hljs-attr">government</span>: {
                    <span class="hljs-attr">majority</span>: majority,
                    <span class="hljs-attr">minority</span>: minority,
                    <span class="hljs-attr">promote</span>: promote
                }
            }
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._governments.shift() || <span class="hljs-keyword">this</span>._arrival() || <span class="hljs-literal">null</span>
}

Shaper.prototype.arrived = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) </span>{
    assert(<span class="hljs-keyword">this</span>._arriving.length &gt; <span class="hljs-number">0</span> &amp;&amp; id == <span class="hljs-keyword">this</span>._arriving[<span class="hljs-number">0</span>].id)
    <span class="hljs-keyword">this</span>._arriving.shift()
}

Shaper.prototype.embark = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arrival</span>) </span>{</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>We do not going to reject a duplicate embarkation for a particular id.</p>
<p>Here is a race condition and how it will shake itself out.</p>
<p>We could be in the middle of arriving a particular islander id when the
islander crashed restarts and submits a new cookie. We will update the
cookie here, but that’s not going to be the same as the cookie that got
written into the log.</p>
<p>We can make it a general case that if the cookies mismatch
every one is very disappointed. Thus, we can catch this on sync.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = <span class="hljs-keyword">this</span>._arriving.length; i &lt; I; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._arriving[i].id == arrival.id) {
            <span class="hljs-keyword">break</span>
        }
    }
    <span class="hljs-keyword">if</span> (i == <span class="hljs-keyword">this</span>._arriving.length) {
        <span class="hljs-keyword">this</span>._arriving.push(arrival)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._arriving[i].properties = arrival.properties
        <span class="hljs-keyword">this</span>._arriving[i].cookie = arrival.cookie
        <span class="hljs-keyword">this</span>._arriving[i].acclimated = arrival.acclimated
    }</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Do nothing if our container indicates that a decision has been reached.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decided ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">this</span>._arrival()
}</pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Generate an arrival government if we have an arrival available.</p>

            </div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Shaper.prototype._arrival = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._arriving.length) {
        <span class="hljs-keyword">var</span> arrival = <span class="hljs-keyword">this</span>._arriving[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">government</span>: {
                <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
                <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority,
                <span class="hljs-attr">arrive</span>: {
                    <span class="hljs-attr">id</span>: arrival.id,
                    <span class="hljs-attr">properties</span>: arrival.properties,
                    <span class="hljs-attr">cookie</span>: arrival.cookie
                },
                <span class="hljs-attr">acclimate</span>: arrival.acclimated ? arrival.id : <span class="hljs-literal">null</span>
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}

Shaper.null = {
    <span class="hljs-attr">unreachable</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> },
    <span class="hljs-attr">acclimate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> },
    <span class="hljs-attr">_arriving</span>: []
}

<span class="hljs-built_in">module</span>.exports = Shaper</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
