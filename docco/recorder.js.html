<!DOCTYPE html>

<html>
<head>
  <title>recorder.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="acceptor.js.html">
                  acceptor.js
                </a>


                <a class="source" href="completion.js.html">
                  completion.js
                </a>


                <a class="source" href="paxos.js.html">
                  paxos.js
                </a>


                <a class="source" href="proposer.js.html">
                  proposer.js
                </a>


                <a class="source" href="recorder.js.html">
                  recorder.js
                </a>


                <a class="source" href="replay.js.html">
                  replay.js
                </a>


                <a class="source" href="shaper.js.html">
                  shaper.js
                </a>


                <a class="source" href="writer.js.html">
                  writer.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>recorder.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO Remember that the code is more complicated than the messaging. Let the
messages absorb some of the complexity of the code. (Divide them. Restrict
their structure.)</p>

            </div>

            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Recorder</span> (<span class="hljs-params">paxos</span>) </span>{
    <span class="hljs-keyword">var</span> entry = paxos.log.head.body
    <span class="hljs-keyword">this</span>.register = {
        <span class="hljs-attr">body</span>: {
            <span class="hljs-attr">promise</span>: entry.promise,
            <span class="hljs-attr">body</span>: entry.body,
            <span class="hljs-attr">previous</span>: entry.previous
        },
        <span class="hljs-attr">previous</span>: <span class="hljs-literal">null</span>
    }
    <span class="hljs-keyword">this</span>._paxos = paxos
}</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We do not need to handle accept messages.</p>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If we received an accept message it would mean that a proposer had a promise
from this islander but the Acceptor that issued the promise has been replaced
by this recorder. That in turn means that we have received a new, stable
government and that government has been written to the atomic log. Our atomic
log is therefore ahead of the atomic log of the sender of the accept message
so the request would have been rejected because the logs are out of sync.</p>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The previous promise of the registered entry submitted will match the
registered entry recorder.</p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This one is because our previous entry is always synonymous with what is in
our atomic log. If we receive a message with a different previous entry then
the atomic logs are out of sync and our whole algorithm has failed. If it is
merely the case that weâ€™re getting a register message that was delayed or
lost a race to write a recover fiat government, then the request would be
rejected because the logs are out of sync.</p>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Recorder.prototype.request = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">now, request</span>) </span>{
    assert(<span class="hljs-regexp">/^prepare|register$/</span>.test(request.method), <span class="hljs-string">'unexpected message to record'</span>)</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Anything else is going to get caught synchronization and rejected.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">switch</span> (request.method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'prepare'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._paxos._prepare(now, request)
    <span class="hljs-keyword">case</span> <span class="hljs-string">'register'</span>:
        assert(request.register.body.previous ==  <span class="hljs-keyword">this</span>.register.body.promise, <span class="hljs-string">'register has unexpected previous'</span>)
        assert(<span class="hljs-keyword">this</span>._paxos.log.head.body.promise == <span class="hljs-keyword">this</span>.register.body.promise, <span class="hljs-string">'recorder and log out of sync'</span>)
        <span class="hljs-keyword">this</span>.register = request.register
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">method</span>: <span class="hljs-string">'receive'</span>, <span class="hljs-attr">promise</span>: <span class="hljs-string">'0/0'</span> }
    }
}

Recorder.prototype.createRecorder = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Recorder(<span class="hljs-keyword">this</span>._paxos)
}

Recorder.prototype.inspect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'Recorder'</span> }
}

<span class="hljs-built_in">module</span>.exports = Recorder</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
