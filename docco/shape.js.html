<!DOCTYPE html>

<html>
<head>
  <title>shape.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="legislator.js.html">
                  legislator.js
                </a>


                <a class="source" href="log.js.html">
                  log.js
                </a>


                <a class="source" href="paxos.js.html">
                  paxos.js
                </a>


                <a class="source" href="proposer.js.html">
                  proposer.js
                </a>


                <a class="source" href="redux.js.html">
                  redux.js
                </a>


                <a class="source" href="replay.js.html">
                  replay.js
                </a>


                <a class="source" href="shape.js.html">
                  shape.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>shape.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Monitor the reachability of denizens in order to suggest the shape of a new
government. The <code>Shape.update</code> method is invoked with a denizen id and a
reachability status. <code>Shape.update</code> returns either a new government to
appoint or <code>null</code>. Once <code>Shape.update</code> returns a new government to appoint
the <code>Shape</code> object is used up and should be replaced.</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We determine reachability elsewhere so that the <code>Shape.update</code> method is only
ever called with a true or false value for reachable. For the purposes of
<code>Shape</code> reachability is defined as follows.</p>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <ul>
<li>A denizen is reachable if the denizen responds to pings and it naturalized.</li>
<li>A denizen is unreachable if the denizen does not respond to pings.</li>
</ul>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If the the denizen responds to pings, but is not naturalized, it is neither
reachable nor unreachable and we don’t want to hear about it.</p>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Notes:</p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Could think harder about priorities as they releate to healing. Wouldn’t want
to starve the recovery of the cluster by performing immigrations only, when
newly naturalized citizens could join the legislature and preserve the
republic.</p>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Note that we currently favor impeachment because the minority updates the
constituents. A non-functioning minority member would keep all of its
constitutents in the dark.</p>

            </div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We favor filling empty seats in government as soon as they are detected.</p>

            </div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>We favor shrinking the government as soon as it becomes obvious that the
government size is less than the population of the island.</p>

            </div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>All this assuming an external mechnism for tracking pings that will calculate
when a paricular participant is reachable or unreachable. After <code>update</code>
returns a reshape operation, the <code>Shape</code> object is consumed. At that point
you should no longer call <code>Shape</code>. Put a dummy shape object in its place.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>A new <code>Shape</code> object should then be created when a new government is created.</p>

            </div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>I’m imagining that the unreachability of a participant will be remembered so
that when a new government is created the unreachability can replayed. Causes
me to muse about whether it should be possible for a citizen to become
reachable again, whether we should continue to ping the citizen, or if we
simply surrender.</p>

            </div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>In the case of collapse when we switch to paxos, it seems that we’ll keep on
trying and trying such that we could recover from a network outage in the
case of paxos.</p>

            </div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO Try to recall what you need to do to grow correctly. Who is supposed to
be in that quorum?</p>

            </div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO Work into the words above that preserving a quorum is urgent, but not
expanding a quorum to the desired parliament size.</p>

            </div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Shape</span> (<span class="hljs-params">parlimentSize, government</span>) </span>{
    <span class="hljs-keyword">this</span>._parliamentSize = government.majority.length * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">this</span>._shouldExpand = parlimentSize != <span class="hljs-keyword">this</span>._parliamentSize
    <span class="hljs-keyword">this</span>._government = government
    <span class="hljs-keyword">this</span>._unreachable = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>._population = government.majority.length + government.minority.length + government.constituents.length
    <span class="hljs-keyword">this</span>._seatsAreEmpty = government.majority.length + government.minority.length != <span class="hljs-keyword">this</span>._parliamentSize
    <span class="hljs-keyword">this</span>._seen = {}
    <span class="hljs-keyword">this</span>._minority = []
    <span class="hljs-keyword">this</span>._exiles = []
    <span class="hljs-keyword">this</span>._expandable = []
}


</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>Shape.update</code> determines if a new government should be created that has a
new shape. Note that immigration takes place is elsewhere.</p>

            </div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Shape.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, reachable</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>We are interested in denizens when they are first reachable or when they
become unreachable. We ignore denizens that continue to be reachable.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> seen = !! <span class="hljs-keyword">this</span>._seen[id]
    <span class="hljs-keyword">if</span> (reachable &amp;&amp; seen) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
    <span class="hljs-keyword">this</span>._seen[id] = <span class="hljs-literal">true</span>

</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>We want to flush any exiles if the entire population has been seen.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> seen = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>._seen).length
    <span class="hljs-keyword">var</span> entirePopulationSeen = seen == <span class="hljs-keyword">this</span>._population

</pre></div></div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Majority members are not our resposibility. They trigger their own
collapse.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (~<span class="hljs-keyword">this</span>._government.majority.indexOf(id)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If the citizen is a minority member we look for impeachments. Also, we
want to take certain actions only after we have ensured that the the
government is as healthy as it can be.</p>

            </div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> minority = ~<span class="hljs-keyword">this</span>._government.minority.indexOf(id)
    <span class="hljs-keyword">if</span> (minority) {
        <span class="hljs-keyword">if</span> (reachable) {
            <span class="hljs-keyword">this</span>._minority.push(id)
        }  <span class="hljs-keyword">else</span> {
</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If minority member is not reachable we impeach it &mdash; remove
it from the government &mdash; immediately.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
                <span class="hljs-attr">government</span>: {
                    <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
                    <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$id</span>) </span>{
                        <span class="hljs-keyword">return</span> $id != id
                    })
                }
            }
        }
</pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If our minority is present and correct we might release an exile if
one detected one, but we’ll keep looking for a citizen to fill an
empty seat if a seat is empty.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (
            <span class="hljs-keyword">this</span>._minority.length == <span class="hljs-keyword">this</span>._government.minority.length &amp;&amp;
            (<span class="hljs-keyword">this</span>._seatsAreEmpty || seen == <span class="hljs-keyword">this</span>._population)
        ) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._exiles.shift() || <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>The citizen is not a minority member.</p>

            </div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (reachable) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._seatsAreEmpty) {
</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Our government has empty seats and we have found a citizen we can
appoint to the minority. This appointment can take priority over
any impeachments so let’s go.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>.government.majority,
                <span class="hljs-attr">government</span>: {
                    <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>.government.majority,
                    <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>.government.minority.concat(id)
                }
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._shouldExpand) {
            <span class="hljs-keyword">this</span>._expandable.push(id)
        }
    } <span class="hljs-keyword">else</span> {
</pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Count as unreachable.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._unreachable++

</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If the reachable population is less than the size of our current
government we need to shrink the government size.</p>
<p>This allows us to move to a more survivable state. A five member
government, for example, can survive two failures. If a five member
government has only four members, however, it can only survive one
failure and with only it’s majority of three it cannot survive any
failures. Shrinking to a three member government means those three
members can survive one failure.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> parliamentSize = <span class="hljs-keyword">this</span>._government.majority.length * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> (parliamentSize &gt; <span class="hljs-keyword">this</span>._population - <span class="hljs-keyword">this</span>._unreachable) {
            <span class="hljs-keyword">var</span> majority = <span class="hljs-keyword">this</span>._government.majority.slice()
            <span class="hljs-keyword">var</span> minority = <span class="hljs-keyword">this</span>._government.minority.slice()
            minority.unshift(majority.pop())
            <span class="hljs-keyword">if</span> (minority.length == majority.length) {
                minority.pop()
            }
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
                <span class="hljs-attr">government</span>: {
                    <span class="hljs-attr">majority</span>: majority,
                    <span class="hljs-attr">minority</span>: minority
                }
            }
        }

</pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Record the unreachable citizen as a potential exile.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._exiles.push({
            <span class="hljs-attr">quorum</span>: <span class="hljs-keyword">this</span>._government.majority,
            <span class="hljs-attr">government</span>: {
                <span class="hljs-attr">majority</span>: <span class="hljs-keyword">this</span>._government.majority,
                <span class="hljs-attr">minority</span>: <span class="hljs-keyword">this</span>._government.minority,
                <span class="hljs-attr">exile</span>: id
            }
        })
    }

</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If as seat is empty we’re going to wait for a citizen to fill those seat.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._seatsAreEmpty &amp;&amp; seen != <span class="hljs-keyword">this</span>._population) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

</pre></div></div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>TODO Is the quorum the new majority or the old majority?
TODO Think about growth commit race conditions again.</p>

            </div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._government.minority.length == <span class="hljs-keyword">this</span>._minority.length) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._shouldExpand &amp;&amp; <span class="hljs-keyword">this</span>._expandable.length &gt;= <span class="hljs-number">2</span>) {
</pre></div></div>

        </li>


        <li id="section-35">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>We should expand and we have citzens who can be appointed to the
government so let’s grow the government.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> majority = <span class="hljs-keyword">this</span>._government.majority.slice()
            <span class="hljs-keyword">var</span> minority = <span class="hljs-keyword">this</span>._government.minority.slice()
            minority.push(<span class="hljs-keyword">this</span>._expandable.shift(), <span class="hljs-keyword">this</span>._expandable.shift())
            majority.push(minority.shift())
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">quorum</span>: majority,
                <span class="hljs-attr">government</span>: { <span class="hljs-attr">majority</span>: majority, <span class="hljs-attr">minority</span>: minority }
            }
        }

</pre></div></div>

        </li>


        <li id="section-36">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Otherwise let’s exile someone if we have someone to exile.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._exiles.shift() || <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}

<span class="hljs-built_in">module</span>.exports = Shape

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
